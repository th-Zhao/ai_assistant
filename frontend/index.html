<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÂ≠¶‰π†Âä©Êâã - Â¢ûÂº∫Áâà</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .gradient-bg {
            background: var(--primary-gradient);
            color: white;
        }

        .card-hover {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            position: relative;
        }

        .message-user {
            background: var(--primary-gradient);
            color: white;
            margin-left: 2rem;
            text-align: right;
        }

        .message-assistant {
            background: white;
            border: 1px solid #dee2e6;
            margin-right: 2rem;
        }

        .session-info {
            background: var(--success-gradient);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 1rem;
        }

        .feature-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .sidebar {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .quiz-container {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .quiz-option {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .quiz-option.selected {
            background: #cfe2ff;
            border-color: #0d6efd;
        }

        .quiz-option.correct {
            background: #d1e7dd;
            border-color: #198754;
        }

        .quiz-option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }

        .session-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .session-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #f8f9fa;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .session-item:hover {
            background: #e9ecef;
        }

        .session-item.active {
            background: var(--primary-gradient);
            color: white;
        }

        .tab-content-area {
            min-height: 600px;
        }

        .response-box {
            background: white;
            border-left: 4px solid #007bff;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .model-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 1rem;
            margin-left: 0.5rem;
        }

        .model-openai {
            background: #10a37f;
            color: white;
        }

        .model-deepseek {
            background: #ff6b35;
            color: white;
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.5rem;
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar navbar-expand-lg gradient-bg shadow">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-robot"></i> Êô∫ËÉΩÂ≠¶‰π†Âä©Êâã 2.0
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item">
                    <span class="navbar-text" id="sessionStatus">
                        <span class="status-indicator status-offline"></span>
                        <span id="sessionId">Êú™ËøûÊé•</span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Â∑¶‰æßËæπÊ†è -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <!-- ‰ºöËØùÁÆ°ÁêÜ -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-chat-dots"></i> ‰ºöËØùÁÆ°ÁêÜ</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="newSession()">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="session-info" id="currentSessionInfo">
                                <div>ÂΩìÂâç‰ºöËØù: <span id="currentSessionId">Êó†</span></div>
                                <div>ÂØπËØùËΩÆÊï∞: <span id="conversationCount">0</span></div>
                            </div>
                            <div class="session-list" id="sessionList">
                                <!-- ‰ºöËØùÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-warning w-100" onclick="clearCurrentSession()">
                                    <i class="bi bi-trash"></i> Ê∏ÖÈô§ÂΩìÂâç‰ºöËØù
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ÊñáÊ°£‰∏ä‰º† -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="bi bi-cloud-upload"></i> ÊñáÊ°£‰∏ä‰º†
                        </div>
                        <div class="card-body">
                            <form id="uploadForm">
                                <input type="file" class="form-control mb-3" id="fileInput" 
                                       accept=".pdf,.txt,.docx" multiple>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-upload"></i> ‰∏ä‰º†ÊñáÊ°£
                                </button>
                            </form>
                            <div id="uploadStatus" class="mt-3"></div>
                            
                            <!-- Â∑≤‰∏ä‰º†ÊñáÊ°£ÂàóË°® -->
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">üìö Â∑≤‰∏ä‰º†ÊñáÊ°£</small>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadDocuments()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div id="documentsList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    <div class="text-muted text-center">
                                        <i class="bi bi-file-earmark"></i> ÊöÇÊó†ÊñáÊ°£
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÊúçÂä°Áä∂ÊÄÅ -->
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-activity"></i> ÊúçÂä°Áä∂ÊÄÅ
                        </div>
                        <div class="card-body">
                            <div id="serviceStatus">
                                <div class="text-muted">Ê≠£Âú®Ê£ÄÊü•...</div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="checkServiceStatus()">
                                <i class="bi bi-arrow-clockwise"></i> Âà∑Êñ∞Áä∂ÊÄÅ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
            <div class="col-lg-9">
                <!-- ÂäüËÉΩÂØºËà™ -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card feature-card card-hover h-100" onclick="showTab('chat')">
                            <div class="card-body text-center">
                                <div class="feature-icon">üí¨</div>
                                <h6>Êô∫ËÉΩÈóÆÁ≠î</h6>
                                <small class="text-muted">ÊîØÊåÅ‰∏ä‰∏ãÊñáËÆ∞ÂøÜ</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card feature-card card-hover h-100" onclick="showTab('summary')">
                            <div class="card-body text-center">
                                <div class="feature-icon">üìã</div>
                                <h6>ÊñáÊ°£ÊÄªÁªì</h6>
                                <small class="text-muted">Êô∫ËÉΩÊèêÂèñË¶ÅÁÇπ</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card feature-card card-hover h-100" onclick="showTab('quiz')">
                            <div class="card-body text-center">
                                <div class="feature-icon">‚ùì</div>
                                <h6>ÁªÉ‰π†È¢ò</h6>
                                <small class="text-muted">Ëá™Âä®ÁîüÊàêÈ¢òÁõÆ</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card feature-card card-hover h-100" onclick="showTab('plan')">
                            <div class="card-body text-center">
                                <div class="feature-icon">üìÖ</div>
                                <h6>Â≠¶‰π†ËÆ°Âàí</h6>
                                <small class="text-muted">‰∏™ÊÄßÂåñËßÑÂàí</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ê†áÁ≠æÈ°µÂÜÖÂÆπ -->
                <div class="tab-content-area">
                    <!-- Êô∫ËÉΩÈóÆÁ≠î -->
                    <div id="chatTab" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><i class="bi bi-chat-text"></i> Êô∫ËÉΩÈóÆÁ≠î</span>
                                    <div>
                                        <label class="form-check-label me-3">
                                            <input type="checkbox" class="form-check-input" id="useDeepSeek"> 
                                            ‰ΩøÁî® DeepSeek
                                        </label>
                                    </div>
                                </div>
                                <!-- ÊñáÊ°£ÈÄâÊã©Âô® - Â§öÈÄâÊ®°Âºè -->
                                <div class="card border-0" style="background: #f8f9fa;">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">üìö ÈÄâÊã©ÊñáÊ°£ËøõË°å‰∏ìÈ¢òÂØπËØù</small>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="selectAllDocuments()">
                                                    <i class="bi bi-check2-all"></i> ÂÖ®ÈÄâ
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="clearDocumentSelection()">
                                                    <i class="bi bi-x-circle"></i> Ê∏ÖÈô§
                                                </button>
                                            </div>
                                        </div>
                                        <div id="documentCheckboxList" style="max-height: 120px; overflow-y: auto;">
                                            <div class="text-muted text-center py-2">
                                                <i class="bi bi-file-earmark"></i> ÊöÇÊó†ÂèØÈÄâÊñáÊ°£
                                            </div>
                                        </div>
                                        <!-- Â∑≤ÈÄâÊã©ÊñáÊ°£ÊòæÁ§∫ -->
                                        <div id="selectedDocumentsInfo" class="mt-2" style="display: none;">
                                            <div class="alert alert-info alert-sm py-1 mb-0">
                                                <i class="bi bi-files"></i> Â∑≤ÈÄâÊã© <span id="selectedDocumentCount">0</span> ‰∏™ÊñáÊ°£Ôºö
                                                <small id="selectedDocumentNames" class="d-block mt-1"></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chat-container" id="chatContainer">
                                    <div class="text-muted text-center">
                                        <i class="bi bi-chat-dots feature-icon"></i>
                                        <p>ÂºÄÂßãÊÇ®ÁöÑÊô∫ËÉΩÂØπËØùÂêßÔºÅ</p>
                                        <small>Á≥ªÁªü‰ºöËÆ∞‰ΩèÂØπËØùÂéÜÂè≤ÔºåÊèê‰æõÊõ¥Â•ΩÁöÑ‰∏ä‰∏ãÊñáÁêÜËß£</small>
                                    </div>
                                </div>
                                <div class="loading-spinner" id="chatLoading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">ÊÄùËÄÉ‰∏≠...</span>
                                    </div>
                                    <p class="mt-2">AIÊ≠£Âú®ÊÄùËÄÉ...</p>
                                </div>
                                <form id="chatForm" class="mt-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="questionInput" 
                                               placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..." autocomplete="off">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send"></i> ÂèëÈÄÅ
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- ÊñáÊ°£ÊÄªÁªì -->
                    <div id="summaryTab" class="tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-file-text"></i> ÊñáÊ°£ÊÄªÁªì
                            </div>
                            <div class="card-body">
                                <div class="d-flex gap-2 mb-3">
                                    <button class="btn btn-success" onclick="generateSummary()">
                                        <i class="bi bi-magic"></i> ÁîüÊàêÊÄªÁªì
                                    </button>
                                    <label class="form-check-label ms-3">
                                        <input type="checkbox" class="form-check-input" id="summaryDeepSeek"> 
                                        ‰ΩøÁî® DeepSeek
                                    </label>
                                </div>
                                <div id="summaryResponse"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ÁªÉ‰π†È¢òÁîüÊàê -->
                    <div id="quizTab" class="tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-question-circle"></i> ÁªÉ‰π†È¢òÁîüÊàê
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">È¢òÁõÆÊï∞Èáè</label>
                                        <select class="form-select" id="questionCount">
                                            <option value="3">3È¢ò</option>
                                            <option value="5" selected>5È¢ò</option>
                                            <option value="10">10È¢ò</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">AIÊ®°Âûã</label>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="quizDeepSeek">
                                            <label class="form-check-label">‰ΩøÁî® DeepSeek</label>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-warning" onclick="generateQuiz()">
                                    <i class="bi bi-lightbulb"></i> ÁîüÊàêÁªÉ‰π†È¢ò
                                </button>
                                <div id="quizResponse"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Â≠¶‰π†ËÆ°Âàí -->
                    <div id="planTab" class="tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-calendar-check"></i> Â≠¶‰π†ËÆ°ÂàíÂà∂ÂÆö
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">ÈöæÂ∫¶Á∫ßÂà´</label>
                                        <select class="form-select" id="difficultyLevel">
                                            <option value="easy">ÂàùÁ∫ß - ÈÄÇÂêàÂÖ•Èó®Â≠¶‰π†</option>
                                            <option value="medium" selected>‰∏≠Á∫ß - Êúâ‰∏ÄÂÆöÂü∫Á°Ä</option>
                                            <option value="hard">È´òÁ∫ß - ÈúÄË¶ÅÊ∑±ÂÖ•ÊéåÊè°</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">AIÊ®°Âûã</label>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="planDeepSeek">
                                            <label class="form-check-label">‰ΩøÁî® DeepSeek</label>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-info" onclick="generateStudyPlan()">
                                    <i class="bi bi-diagram-3"></i> Âà∂ÂÆöÂ≠¶‰π†ËÆ°Âàí
                                </button>
                                <div id="planResponse"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000';
        let currentSessionId = null;
        let selectedDocumentIds = []; // ÊîØÊåÅÂ§öÊñáÊ°£ÈÄâÊã©
        let selectedDocuments = {}; // Â≠òÂÇ®ÊñáÊ°£IDÂíåÂêçÁß∞ÁöÑÊò†Â∞Ñ

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            newSession();
            loadSessions();
            checkServiceStatus();
            loadDocuments();
            showTab('chat');
        });

        // ÁîüÊàêÊñ∞‰ºöËØùID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ÂàõÂª∫Êñ∞‰ºöËØù
        function newSession() {
            currentSessionId = generateSessionId();
            updateSessionStatus();
            clearChatContainer();
            addSystemMessage('Êñ∞‰ºöËØùÂ∑≤ÂàõÂª∫ÔºåÊÇ®ÂèØ‰ª•ÂºÄÂßãÊèêÈóÆ‰∫ÜÔºÅ');
        }

        // Êõ¥Êñ∞‰ºöËØùÁä∂ÊÄÅÊòæÁ§∫
        function updateSessionStatus() {
            document.getElementById('currentSessionId').textContent = currentSessionId || 'Êó†';
            document.getElementById('sessionId').textContent = currentSessionId || 'Êú™ËøûÊé•';
            
            if (currentSessionId) {
                document.querySelector('.status-indicator').className = 'status-indicator status-online';
            } else {
                document.querySelector('.status-indicator').className = 'status-indicator status-offline';
            }
        }

        // Ê∏ÖÈô§ÂΩìÂâç‰ºöËØù
        async function clearCurrentSession() {
            if (!currentSessionId) return;
            
            try {
                const response = await fetch(`${API_BASE}/conversation/${currentSessionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    clearChatContainer();
                    addSystemMessage('‰ºöËØùÂ∑≤Ê∏ÖÈô§');
                    loadSessions();
                }
            } catch (error) {
                console.error('Ê∏ÖÈô§‰ºöËØùÂ§±Ë¥•:', error);
            }
        }

        // Ê∏ÖÁ©∫ËÅäÂ§©ÂÆπÂô®
        function clearChatContainer() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
        }

        // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
        function addSystemMessage(message) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-info';
            messageDiv.innerHTML = `<i class="bi bi-info-circle"></i> ${message}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÂÆπÂô®
        function addMessage(content, isUser, metadata = {}) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            
            if (isUser) {
                messageDiv.className = 'message message-user';
                messageDiv.innerHTML = `
                    <div><strong>Êàë:</strong></div>
                    <div class="mt-1">${content}</div>
                `;
            } else {
                messageDiv.className = 'message message-assistant';
                const modelBadge = metadata.model_used ? 
                    `<span class="model-badge model-${metadata.model_used.toLowerCase()}">${metadata.model_used}</span>` : '';
                const contextInfo = metadata.context_used ? 
                    '<small class="text-muted"><i class="bi bi-link-45deg"></i> ‰ΩøÁî®‰∫Ü‰∏ä‰∏ãÊñá</small>' : '';
                
                messageDiv.innerHTML = `
                    <div><strong>Âä©Êâã:</strong> ${modelBadge}</div>
                    <div class="mt-1">${content.replace(/\n/g, '<br>')}</div>
                    ${contextInfo ? `<div class="mt-1">${contextInfo}</div>` : ''}
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
        function toggleLoading(show) {
            document.getElementById('chatLoading').style.display = show ? 'block' : 'none';
        }

        // ÊòæÁ§∫Ê†áÁ≠æÈ°µ
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }

        // Âä†ËΩΩÊñáÊ°£ÂàóË°® - ÊîØÊåÅÂ§öÈÄâ
        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/documents`);
                const result = await response.json();
                
                const documentsList = document.getElementById('documentsList');
                const documentCheckboxList = document.getElementById('documentCheckboxList');
                
                if (result.success && result.documents.length > 0) {
                    // Êõ¥Êñ∞Êô∫ËÉΩÈóÆÁ≠îÁöÑÊñáÊ°£ÈÄâÊã©Âô®ÔºàcheckboxÂàóË°®Ôºâ
                    let checkboxHtml = '';
                    result.documents.forEach(doc => {
                        const isChecked = selectedDocumentIds.includes(doc.document_id);
                        selectedDocuments[doc.document_id] = doc.filename; // ‰øùÂ≠òÊò†Â∞Ñ
                        
                        checkboxHtml += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="doc_${doc.document_id}" 
                                       value="${doc.document_id}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="onDocumentSelectionChange()">
                                <label class="form-check-label" for="doc_${doc.document_id}">
                                    üìÑ ${doc.filename}
                                </label>
                            </div>
                        `;
                    });
                    documentCheckboxList.innerHTML = checkboxHtml;
                    
                    // Êõ¥Êñ∞‰æßËæπÊ†èÁöÑÊñáÊ°£ÂàóË°®
                    let documentsHtml = '';
                    result.documents.forEach(doc => {
                        const date = new Date(doc.created_at).toLocaleDateString();
                        const sizeKB = Math.round(doc.total_chars / 1024);
                        documentsHtml += `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-truncate" style="max-width: 150px;" title="${doc.filename}">
                                        üìÑ ${doc.filename}
                                    </div>
                                    <small class="text-muted">
                                        ${doc.chunk_count} Âùó ¬∑ ${sizeKB}KB ¬∑ ${date}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument('${doc.document_id}')" title="Âà†Èô§ÊñáÊ°£">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;
                    });
                    documentsList.innerHTML = documentsHtml;
                } else {
                    // Êó†ÊñáÊ°£ÁöÑÊÉÖÂÜµ
                    documentCheckboxList.innerHTML = `
                        <div class="text-muted text-center py-2">
                            <i class="bi bi-file-earmark"></i> ÊöÇÊó†ÂèØÈÄâÊñáÊ°£
                        </div>
                    `;
                    documentsList.innerHTML = `
                        <div class="text-muted text-center">
                            <i class="bi bi-file-earmark"></i> ÊöÇÊó†ÊñáÊ°£
                        </div>
                    `;
                }
                
                // Êõ¥Êñ∞ÈÄâÊã©Áä∂ÊÄÅÊòæÁ§∫
                updateSelectedDocumentsDisplay();
                
            } catch (error) {
                console.error('Âä†ËΩΩÊñáÊ°£ÂàóË°®Â§±Ë¥•:', error);
                document.getElementById('documentCheckboxList').innerHTML = `
                    <div class="text-danger text-center py-2">
                        <i class="bi bi-exclamation-triangle"></i> Âä†ËΩΩÂ§±Ë¥•
                    </div>
                `;
                document.getElementById('documentsList').innerHTML = `
                    <div class="text-danger text-center">
                        <i class="bi bi-exclamation-triangle"></i> Âä†ËΩΩÂ§±Ë¥•
                    </div>
                `;
            }
        }

        // Â§öÊñáÊ°£ÈÄâÊã©Áõ∏ÂÖ≥ÂáΩÊï∞
        function onDocumentSelectionChange() {
            // Ëé∑ÂèñÊâÄÊúâÈÄâ‰∏≠ÁöÑÊñáÊ°£
            const checkboxes = document.querySelectorAll('#documentCheckboxList input[type="checkbox"]:checked');
            selectedDocumentIds = Array.from(checkboxes).map(cb => cb.value);
            
            updateSelectedDocumentsDisplay();
            
            // ÁªôÁî®Êà∑ÊèêÁ§∫
            if (selectedDocumentIds.length > 0) {
                const docNames = selectedDocumentIds.map(id => selectedDocuments[id]).join('„ÄÅ');
                addSystemMessage(`üìö Â∑≤ÈÄâÊã© ${selectedDocumentIds.length} ‰∏™ÊñáÊ°£Ôºö${docNames}„ÄÇAIÂ∞ÜÂü∫‰∫éËøô‰∫õÊñáÊ°£ÂõûÁ≠îÈóÆÈ¢ò„ÄÇ`);
            } else {
                addSystemMessage('üß† Â∑≤ÂàáÊç¢Âà∞Á∫ØÂ§ßÊ®°ÂûãÊ®°ÂºèÔºåAIÂ∞ÜÂü∫‰∫éËÆ≠ÁªÉÁü•ËØÜÂõûÁ≠îÈóÆÈ¢ò„ÄÇ');
            }
        }
        
        function selectAllDocuments() {
            const checkboxes = document.querySelectorAll('#documentCheckboxList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            onDocumentSelectionChange();
        }
        
        function clearDocumentSelection() {
            const checkboxes = document.querySelectorAll('#documentCheckboxList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            onDocumentSelectionChange();
        }
        
        function updateSelectedDocumentsDisplay() {
            const selectedInfo = document.getElementById('selectedDocumentsInfo');
            const countSpan = document.getElementById('selectedDocumentCount');
            const namesSpan = document.getElementById('selectedDocumentNames');
            
            if (selectedDocumentIds.length > 0) {
                const docNames = selectedDocumentIds.map(id => selectedDocuments[id]).join('„ÄÅ');
                countSpan.textContent = selectedDocumentIds.length;
                namesSpan.textContent = docNames;
                selectedInfo.style.display = 'block';
            } else {
                selectedInfo.style.display = 'none';
            }
        }

        // Âà†Èô§ÊñáÊ°£
        async function deleteDocument(documentId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÊ°£ÂêóÔºü')) return;
            
            try {
                const response = await fetch(`${API_BASE}/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadDocuments(); // Âà∑Êñ∞ÊñáÊ°£ÂàóË°®
                    checkServiceStatus(); // Êõ¥Êñ∞ÊúçÂä°Áä∂ÊÄÅ
                    alert('ÊñáÊ°£Âà†Èô§ÊàêÂäü');
                } else {
                    alert('Âà†Èô§Â§±Ë¥•Ôºö' + result.error);
                }
            } catch (error) {
                console.error('Âà†Èô§ÊñáÊ°£Â§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•ÔºöÁΩëÁªúÈîôËØØ');
            }
        }

        // Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ
        async function checkServiceStatus() {
            try {
                const response = await fetch(`${API_BASE}/service-status`);
                const result = await response.json();
                
                if (result.success) {
                    const status = result.service_status;
                    const statusHtml = `
                        <div class="mb-2">
                            <small class="text-muted">AIÊúçÂä°:</small><br>
                            <span class="status-indicator ${status.ai_service.openai_available ? 'status-online' : 'status-offline'}"></span>
                            OpenAI: ${status.ai_service.openai_available ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'}<br>
                            <span class="status-indicator ${status.ai_service.deepseek_available ? 'status-online' : 'status-offline'}"></span>
                            DeepSeek: ${status.ai_service.deepseek_available ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'}
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">‰ºöËØùÊúçÂä°:</small><br>
                            <span class="status-indicator ${status.session_service.redis_connected ? 'status-online' : 'status-warning'}"></span>
                            ${status.session_service.storage_type === 'redis' ? 'Redis' : 'ÂÜÖÂ≠ò'} Â≠òÂÇ®<br>
                            Ê¥ªË∑É‰ºöËØù: ${status.session_service.active_sessions}
                        </div>
                        <div>
                            <small class="text-muted">ÊñáÊ°£ÊúçÂä°:</small><br>
                            Â∑≤‰∏ä‰º†ÊñáÊ°£: ${status.rag_service.document_count}
                        </div>
                    `;
                    document.getElementById('serviceStatus').innerHTML = statusHtml;
                }
            } catch (error) {
                document.getElementById('serviceStatus').innerHTML = 
                    '<div class="text-danger">ÊúçÂä°Áä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•</div>';
            }
        }

        // Âä†ËΩΩ‰ºöËØùÂàóË°®
        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/sessions`);
                const result = await response.json();
                
                if (result.success) {
                    const sessionList = document.getElementById('sessionList');
                    sessionList.innerHTML = '';
                    
                    if (result.sessions.length === 0) {
                        sessionList.innerHTML = '<div class="text-muted text-center">ÊöÇÊó†‰ºöËØù</div>';
                        return;
                    }
                    
                    result.sessions.forEach(session => {
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = `session-item ${session.session_id === currentSessionId ? 'active' : ''}`;
                        const date = new Date(session.last_activity * 1000).toLocaleString();
                        sessionDiv.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <small>${session.session_id.substr(0, 12)}...</small>
                                <small>${session.conversation_count}ËΩÆ</small>
                            </div>
                            <small class="text-muted">${date}</small>
                        `;
                        sessionDiv.onclick = () => switchSession(session.session_id);
                        sessionList.appendChild(sessionDiv);
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩ‰ºöËØùÂàóË°®Â§±Ë¥•:', error);
            }
        }

        // ÂàáÊç¢‰ºöËØù
        async function switchSession(sessionId) {
            currentSessionId = sessionId;
            updateSessionStatus();
            clearChatContainer();
            
            // Âä†ËΩΩ‰ºöËØùÂéÜÂè≤
            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`);
                const result = await response.json();
                
                if (result.success && result.session_info.conversations) {
                    result.session_info.conversations.forEach(conv => {
                        addMessage(conv.question, true);
                        addMessage(conv.answer, false, {
                            model_used: conv.model_used,
                            context_used: true
                        });
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩ‰ºöËØùÂéÜÂè≤Â§±Ë¥•:', error);
            }
            
            loadSessions(); // Êõ¥Êñ∞‰ºöËØùÂàóË°®Áä∂ÊÄÅ
        }

        // ÊñáÊ°£‰∏ä‰º†
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('ËØ∑ÈÄâÊã©Êñá‰ª∂');
                return;
            }
            
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> ‰∏ä‰º†‰∏≠...';
            
            let uploadResults = [];
            
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('file', files[i]);
                
                try {
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        uploadResults.push(`<div class="alert alert-success alert-sm">‚úÖ ${files[i].name} ‰∏ä‰º†ÊàêÂäü</div>`);
                    } else {
                        uploadResults.push(`<div class="alert alert-danger alert-sm">‚ùå ${files[i].name} ‰∏ä‰º†Â§±Ë¥•: ${result.error || 'Êú™Áü•ÈîôËØØ'}</div>`);
                    }
                } catch (error) {
                    uploadResults.push(`<div class="alert alert-danger alert-sm">‚ùå ${files[i].name} ÁΩëÁªúÈîôËØØ</div>`);
                }
            }
            
            // Ê∏ÖÈô§"‰∏ä‰º†‰∏≠..."Áä∂ÊÄÅÔºåÊòæÁ§∫ÊúÄÁªàÁªìÊûú
            statusDiv.innerHTML = uploadResults.join('');
            
            // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•Ê°Ü
            fileInput.value = '';
            
            checkServiceStatus(); // Êõ¥Êñ∞ÊñáÊ°£Êï∞Èáè
            loadDocuments(); // Âà∑Êñ∞ÊñáÊ°£ÂàóË°®
        });

        // Êô∫ËÉΩÈóÆÁ≠î
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) return;
            
            if (!currentSessionId) {
                newSession();
            }
            
            addMessage(question, true);
            questionInput.value = '';
            toggleLoading(true);
            
            try {
                const useDeepSeek = document.getElementById('useDeepSeek').checked;
                const response = await fetch(`${API_BASE}/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        use_deepseek: useDeepSeek,
                        session_id: currentSessionId,
                        document_ids: selectedDocumentIds // ‰º†ÈÄíÈÄâ‰∏≠ÁöÑÂ§ö‰∏™ÊñáÊ°£ID
                    })
                });
                
                const result = await response.json();
                toggleLoading(false);
                
                if (result.success) {
                    addMessage(result.answer, false, {
                        model_used: result.model_used,
                        context_used: result.context_used
                    });
                    loadSessions(); // Êõ¥Êñ∞‰ºöËØùÂàóË°®
                } else {
                    addMessage(`Êä±Ê≠âÔºåÂõûÁ≠îÂ§±Ë¥•Ôºö${result.error}`, false);
                }
            } catch (error) {
                toggleLoading(false);
                addMessage('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', false);
            }
        });

        // ÁîüÊàêÊÄªÁªì
        async function generateSummary() {
            const useDeepSeek = document.getElementById('summaryDeepSeek').checked;
            const responseDiv = document.getElementById('summaryResponse');
            
            responseDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Ê≠£Âú®ÁîüÊàêÊÄªÁªì...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/summary?use_deepseek=${useDeepSeek}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    responseDiv.innerHTML = `
                        <div class="response-box">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>üìã ÊñáÊ°£ÊÄªÁªì</h5>
                                <span class="model-badge model-${result.model_used.toLowerCase()}">${result.model_used}</span>
                            </div>
                            <div>${result.summary.replace(/\n/g, '<br>')}</div>
                            <hr>
                            <small class="text-muted">Âü∫‰∫é ${result.document_count} ‰∏™ÊñáÊ°£ÁîüÊàê</small>
                        </div>
                    `;
                } else {
                    responseDiv.innerHTML = `<div class="alert alert-warning">${result.error}</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = '<div class="alert alert-danger">ÁΩëÁªúÈîôËØØ</div>';
            }
        }

        // ÁîüÊàêÁªÉ‰π†È¢ò
        async function generateQuiz() {
            const questionCount = document.getElementById('questionCount').value;
            const useDeepSeek = document.getElementById('quizDeepSeek').checked;
            const responseDiv = document.getElementById('quizResponse');
            
            responseDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Ê≠£Âú®ÁîüÊàêÁªÉ‰π†È¢ò...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/quiz`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_count: parseInt(questionCount),
                        use_deepseek: useDeepSeek
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.quiz.questions) {
                    let quizHtml = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>‚ùì ÁªÉ‰π†È¢ò</h5>
                            <span class="model-badge model-${result.model_used.toLowerCase()}">${result.model_used}</span>
                        </div>
                    `;
                    
                    result.quiz.questions.forEach((q, index) => {
                        quizHtml += `<div class="quiz-container">
                            <h6>È¢òÁõÆ ${index + 1}Ôºö${q.question}</h6>`;
                        
                        if (q.type === 'choice' && q.options) {
                            quizHtml += '<div class="mt-2">';
                            q.options.forEach((option, optIndex) => {
                                quizHtml += `<div class="quiz-option" onclick="selectOption(this, '${q.correct_answer}', '${option.charAt(0)}')">${option}</div>`;
                            });
                            quizHtml += '</div>';
                        } else if (q.type === 'judge') {
                            quizHtml += `
                                <div class="mt-2">
                                    <div class="quiz-option" onclick="selectOption(this, '${q.correct_answer}', 'true')">A. Ê≠£Á°Æ</div>
                                    <div class="quiz-option" onclick="selectOption(this, '${q.correct_answer}', 'false')">B. ÈîôËØØ</div>
                                </div>
                            `;
                        } else {
                            quizHtml += `<div class="mt-2"><strong>ÂèÇËÄÉÁ≠îÊ°àÔºö</strong>${q.correct_answer}</div>`;
                        }
                        
                        quizHtml += `<div class="mt-2"><small class="text-muted"><strong>Ëß£ÈáäÔºö</strong>${q.explanation}</small></div></div>`;
                    });
                    
                    responseDiv.innerHTML = quizHtml;
                } else {
                    responseDiv.innerHTML = `<div class="alert alert-warning">${result.error || 'ÁªÉ‰π†È¢òÁîüÊàêÂ§±Ë¥•'}</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = '<div class="alert alert-danger">ÁΩëÁªúÈîôËØØ</div>';
            }
        }

        // ÈÄâÊã©È¢òÁõÆÈÄâÈ°π
        function selectOption(element, correctAnswer, selectedAnswer) {
            // ÈáçÁΩÆÂêåÁ∫ßÈÄâÈ°π
            const siblings = element.parentNode.querySelectorAll('.quiz-option');
            siblings.forEach(sibling => {
                sibling.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Ê†áËÆ∞ÈÄâ‰∏≠
            element.classList.add('selected');
            
            // ÊòæÁ§∫ÁªìÊûú
            setTimeout(() => {
                if (selectedAnswer === correctAnswer) {
                    element.classList.add('correct');
                } else {
                    element.classList.add('incorrect');
                    // ÊòæÁ§∫Ê≠£Á°ÆÁ≠îÊ°à
                    siblings.forEach(sibling => {
                        if (sibling.textContent.startsWith(correctAnswer)) {
                            sibling.classList.add('correct');
                        }
                    });
                }
            }, 100);
        }

        // ÁîüÊàêÂ≠¶‰π†ËÆ°Âàí
        async function generateStudyPlan() {
            const difficulty = document.getElementById('difficultyLevel').value;
            const useDeepSeek = document.getElementById('planDeepSeek').checked;
            const responseDiv = document.getElementById('planResponse');
            
            responseDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Ê≠£Âú®Âà∂ÂÆöÂ≠¶‰π†ËÆ°Âàí...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/study-plan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        difficulty: difficulty,
                        use_deepseek: useDeepSeek
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    responseDiv.innerHTML = `
                        <div class="response-box">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>üìÖ Â≠¶‰π†ËÆ°Âàí</h5>
                                <span class="model-badge model-${result.model_used.toLowerCase()}">${result.model_used}</span>
                            </div>
                            <div>${result.study_plan.replace(/\n/g, '<br>')}</div>
                            <hr>
                            <small class="text-muted">ÈöæÂ∫¶Á∫ßÂà´Ôºö${result.difficulty} | Âü∫‰∫é ${result.document_count} ‰∏™ÊñáÊ°£</small>
                        </div>
                    `;
                } else {
                    responseDiv.innerHTML = `<div class="alert alert-warning">${result.error}</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = '<div class="alert alert-danger">ÁΩëÁªúÈîôËØØ</div>';
            }
        }

        // ÂÆöÊúüÂà∑Êñ∞‰ºöËØùÁä∂ÊÄÅ
        setInterval(() => {
            if (currentSessionId) {
                loadSessions();
            }
        }, 30000); // ÊØè30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
    </script>
</body>
</html> 
</html> 