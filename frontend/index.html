<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹ - å¢å¼ºç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .gradient-bg {
            background: var(--primary-gradient);
            color: white;
        }

        .card-hover {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            position: relative;
        }

        .message-user {
            background: var(--primary-gradient);
            color: white;
            margin-left: 2rem;
            text-align: right;
        }

        .message-assistant {
            background: white;
            border: 1px solid #dee2e6;
            margin-right: 2rem;
        }

        .session-info {
            background: var(--success-gradient);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 1rem;
        }

        .feature-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .sidebar {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .quiz-container {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .quiz-option {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .quiz-option.selected {
            background: #cfe2ff;
            border-color: #0d6efd;
        }

        .quiz-option.correct {
            background: #d1e7dd;
            border-color: #198754;
        }

        .quiz-option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }

        .session-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .session-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #f8f9fa;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .session-item:hover {
            background: #e9ecef;
        }

        .session-item.active {
            background: var(--primary-gradient);
            color: white;
        }

        .tab-content-area {
            min-height: 600px;
        }

        .response-box {
            background: white;
            border-left: 4px solid #007bff;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .model-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 1rem;
            margin-left: 0.5rem;
        }

        .model-openai {
            background: #10a37f;
            color: white;
        }

        .model-deepseek {
            background: #ff6b35;
            color: white;
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.5rem;
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg gradient-bg shadow">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-robot"></i> æ™ºèƒ½å­¦ä¹ åŠ©æ‰‹ 2.0
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item">
                    <span class="navbar-text" id="sessionStatus">
                        <span class="status-indicator status-offline"></span>
                        <span id="sessionId">æœªè¿æ¥</span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- å·¦ä¾§è¾¹æ  -->
            <div class="col-lg-3">
                <div class="sidebar">
                    <!-- ä¼šè¯ç®¡ç† -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-chat-dots"></i> ä¼šè¯ç®¡ç†</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="newSession()">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="session-info" id="currentSessionInfo">
                                <div>å½“å‰ä¼šè¯: <span id="currentSessionId">æ— </span></div>
                                <div>å¯¹è¯è½®æ•°: <span id="conversationCount">0</span></div>
                            </div>
                            <div class="session-list" id="sessionList">
                                <!-- ä¼šè¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-warning w-100" onclick="clearCurrentSession()">
                                    <i class="bi bi-trash"></i> æ¸…é™¤å½“å‰ä¼šè¯
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡æ¡£ä¸Šä¼  -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="bi bi-cloud-upload"></i> æ–‡æ¡£ä¸Šä¼ 
                        </div>
                        <div class="card-body">
                            <form id="uploadForm">
                                <input type="file" class="form-control mb-3" id="fileInput" 
                                       accept=".pdf,.txt,.docx" multiple>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-upload"></i> ä¸Šä¼ æ–‡æ¡£
                                </button>
                            </form>
                            <div id="uploadStatus" class="mt-3"></div>
                            
                            <!-- å·²ä¸Šä¼ æ–‡æ¡£åˆ—è¡¨ -->
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">ğŸ“š å·²ä¸Šä¼ æ–‡æ¡£</small>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadDocuments()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div id="documentsList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    <div class="text-muted text-center">
                                        <i class="bi bi-file-earmark"></i> æš‚æ— æ–‡æ¡£
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æœåŠ¡çŠ¶æ€ -->
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-activity"></i> æœåŠ¡çŠ¶æ€
                        </div>
                        <div class="card-body">
                            <div id="serviceStatus">
                                <div class="text-muted">æ­£åœ¨æ£€æŸ¥...</div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="checkServiceStatus()">
                                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°çŠ¶æ€
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="col-lg-9">
                <!-- åŠŸèƒ½å¯¼èˆª -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card feature-card card-hover h-100" onclick="showTab('chat')">
                            <div class="card-body text-center">
                                <div class="feature-icon">ğŸ’¬</div>
                                <h6>æ™ºèƒ½é—®ç­”</h6>
                                <small class="text-muted">æ”¯æŒä¸Šä¸‹æ–‡è®°å¿†</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card feature-card card-hover h-100" onclick="showTab('summary')">
                            <div class="card-body text-center">
                                <div class="feature-icon">ğŸ“‹</div>
                                <h6>æ–‡æ¡£æ€»ç»“</h6>
                                <small class="text-muted">æ™ºèƒ½æå–è¦ç‚¹</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card feature-card card-hover h-100" onclick="showTab('quiz')">
                            <div class="card-body text-center">
                                <div class="feature-icon">â“</div>
                                <h6>ç»ƒä¹ é¢˜</h6>
                                <small class="text-muted">è‡ªåŠ¨ç”Ÿæˆé¢˜ç›®</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card feature-card card-hover h-100" onclick="showTab('plan')">
                            <div class="card-body text-center">
                                <div class="feature-icon">ğŸ“…</div>
                                <h6>å­¦ä¹ è®¡åˆ’</h6>
                                <small class="text-muted">ä¸ªæ€§åŒ–è§„åˆ’</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ ‡ç­¾é¡µå†…å®¹ -->
                <div class="tab-content-area">
                    <!-- æ™ºèƒ½é—®ç­” -->
                    <div id="chatTab" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><i class="bi bi-chat-text"></i> æ™ºèƒ½é—®ç­”</span>
                                    <div>
                                        <label class="form-check-label me-3">
                                            <input type="checkbox" class="form-check-input" id="useDeepSeek"> 
                                            ä½¿ç”¨ DeepSeek
                                        </label>
                                    </div>
                                </div>
                                <!-- æ–‡æ¡£é€‰æ‹©å™¨ - å¤šé€‰æ¨¡å¼ -->
                                <div class="card border-0" style="background: #f8f9fa;">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">ğŸ“š é€‰æ‹©æ–‡æ¡£è¿›è¡Œä¸“é¢˜å¯¹è¯</small>
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="selectAllDocuments()">
                                                    <i class="bi bi-check2-all"></i> å…¨é€‰
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="clearDocumentSelection()">
                                                    <i class="bi bi-x-circle"></i> æ¸…é™¤
                                                </button>
                                            </div>
                                        </div>
                                        <div id="documentCheckboxList" style="max-height: 120px; overflow-y: auto;">
                                            <div class="text-muted text-center py-2">
                                                <i class="bi bi-file-earmark"></i> æš‚æ— å¯é€‰æ–‡æ¡£
                                            </div>
                                        </div>
                                        <!-- å·²é€‰æ‹©æ–‡æ¡£æ˜¾ç¤º -->
                                        <div id="selectedDocumentsInfo" class="mt-2" style="display: none;">
                                            <div class="alert alert-info alert-sm py-1 mb-0">
                                                <i class="bi bi-files"></i> å·²é€‰æ‹© <span id="selectedDocumentCount">0</span> ä¸ªæ–‡æ¡£ï¼š
                                                <small id="selectedDocumentNames" class="d-block mt-1"></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chat-container" id="chatContainer">
                                    <div class="text-muted text-center">
                                        <i class="bi bi-chat-dots feature-icon"></i>
                                        <p>å¼€å§‹æ‚¨çš„æ™ºèƒ½å¯¹è¯å§ï¼</p>
                                        <small>ç³»ç»Ÿä¼šè®°ä½å¯¹è¯å†å²ï¼Œæä¾›æ›´å¥½çš„ä¸Šä¸‹æ–‡ç†è§£</small>
                                    </div>
                                </div>
                                <div class="loading-spinner" id="chatLoading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">æ€è€ƒä¸­...</span>
                                    </div>
                                    <p class="mt-2">AIæ­£åœ¨æ€è€ƒ...</p>
                                </div>
                                <form id="chatForm" class="mt-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="questionInput" 
                                               placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send"></i> å‘é€
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡æ¡£æ€»ç»“ -->
                    <div id="summaryTab" class="tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-file-text"></i> æ–‡æ¡£æ€»ç»“
                            </div>
                            <div class="card-body">
                                <div class="d-flex gap-2 mb-3">
                                    <button class="btn btn-success" onclick="generateSummary()">
                                        <i class="bi bi-magic"></i> ç”Ÿæˆæ€»ç»“
                                    </button>
                                    <label class="form-check-label ms-3">
                                        <input type="checkbox" class="form-check-input" id="summaryDeepSeek"> 
                                        ä½¿ç”¨ DeepSeek
                                    </label>
                                </div>
                                <div id="summaryResponse"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ç»ƒä¹ é¢˜ç”Ÿæˆ -->
                    <div id="quizTab" class="tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-question-circle"></i> ç»ƒä¹ é¢˜ç”Ÿæˆ
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">é¢˜ç›®æ•°é‡</label>
                                        <select class="form-select" id="questionCount">
                                            <option value="3">3é¢˜</option>
                                            <option value="5" selected>5é¢˜</option>
                                            <option value="10">10é¢˜</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">AIæ¨¡å‹</label>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="quizDeepSeek">
                                            <label class="form-check-label">ä½¿ç”¨ DeepSeek</label>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-warning" onclick="generateQuiz()">
                                    <i class="bi bi-lightbulb"></i> ç”Ÿæˆç»ƒä¹ é¢˜
                                </button>
                                <div id="quizResponse"></div>
                            </div>
                        </div>
                    </div>

                    <!-- å­¦ä¹ è®¡åˆ’ -->
                    <div id="planTab" class="tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-calendar-check"></i> å­¦ä¹ è®¡åˆ’åˆ¶å®š
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">éš¾åº¦çº§åˆ«</label>
                                        <select class="form-select" id="difficultyLevel">
                                            <option value="easy">åˆçº§ - é€‚åˆå…¥é—¨å­¦ä¹ </option>
                                            <option value="medium" selected>ä¸­çº§ - æœ‰ä¸€å®šåŸºç¡€</option>
                                            <option value="hard">é«˜çº§ - éœ€è¦æ·±å…¥æŒæ¡</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">AIæ¨¡å‹</label>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="planDeepSeek">
                                            <label class="form-check-label">ä½¿ç”¨ DeepSeek</label>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-info" onclick="generateStudyPlan()">
                                    <i class="bi bi-diagram-3"></i> åˆ¶å®šå­¦ä¹ è®¡åˆ’
                                </button>
                                <div id="planResponse"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000';
        let currentSessionId = null;
        let selectedDocumentIds = []; // æ”¯æŒå¤šæ–‡æ¡£é€‰æ‹©
        let selectedDocuments = {}; // å­˜å‚¨æ–‡æ¡£IDå’Œåç§°çš„æ˜ å°„

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            newSession();
            loadSessions();
            checkServiceStatus();
            loadDocuments();
            showTab('chat');
        });

        // ç”Ÿæˆæ–°ä¼šè¯ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // åˆ›å»ºæ–°ä¼šè¯
        function newSession() {
            currentSessionId = generateSessionId();
            updateSessionStatus();
            clearChatContainer();
            addSystemMessage('æ–°ä¼šè¯å·²åˆ›å»ºï¼Œæ‚¨å¯ä»¥å¼€å§‹æé—®äº†ï¼');
        }

        // æ›´æ–°ä¼šè¯çŠ¶æ€æ˜¾ç¤º
        function updateSessionStatus() {
            document.getElementById('currentSessionId').textContent = currentSessionId || 'æ— ';
            document.getElementById('sessionId').textContent = currentSessionId || 'æœªè¿æ¥';
            
            if (currentSessionId) {
                document.querySelector('.status-indicator').className = 'status-indicator status-online';
            } else {
                document.querySelector('.status-indicator').className = 'status-indicator status-offline';
            }
        }

        // æ¸…é™¤å½“å‰ä¼šè¯
        async function clearCurrentSession() {
            if (!currentSessionId) return;
            
            try {
                const response = await fetch(`${API_BASE}/conversation/${currentSessionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    clearChatContainer();
                    addSystemMessage('ä¼šè¯å·²æ¸…é™¤');
                    loadSessions();
                }
            } catch (error) {
                console.error('æ¸…é™¤ä¼šè¯å¤±è´¥:', error);
            }
        }

        // æ¸…ç©ºèŠå¤©å®¹å™¨
        function clearChatContainer() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(message) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-info';
            messageDiv.innerHTML = `<i class="bi bi-info-circle"></i> ${message}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨
        function addMessage(content, isUser, metadata = {}) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            
            if (isUser) {
                messageDiv.className = 'message message-user';
                messageDiv.innerHTML = `
                    <div><strong>æˆ‘:</strong></div>
                    <div class="mt-1">${content}</div>
                `;
            } else {
                messageDiv.className = 'message message-assistant';
                const modelBadge = metadata.model_used ? 
                    `<span class="model-badge model-${metadata.model_used.toLowerCase()}">${metadata.model_used}</span>` : '';
                const contextInfo = metadata.context_used ? 
                    '<small class="text-muted"><i class="bi bi-link-45deg"></i> ä½¿ç”¨äº†ä¸Šä¸‹æ–‡</small>' : '';
                
                messageDiv.innerHTML = `
                    <div><strong>åŠ©æ‰‹:</strong> ${modelBadge}</div>
                    <div class="mt-1">${content.replace(/\n/g, '<br>')}</div>
                    ${contextInfo ? `<div class="mt-1">${contextInfo}</div>` : ''}
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function toggleLoading(show) {
            document.getElementById('chatLoading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºæ ‡ç­¾é¡µ
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }

        // åŠ è½½æ–‡æ¡£åˆ—è¡¨ - æ”¯æŒå¤šé€‰
        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/documents`);
                const result = await response.json();
                
                const documentsList = document.getElementById('documentsList');
                const documentCheckboxList = document.getElementById('documentCheckboxList');
                
                if (result.success && result.documents.length > 0) {
                    // æ›´æ–°æ™ºèƒ½é—®ç­”çš„æ–‡æ¡£é€‰æ‹©å™¨ï¼ˆcheckboxåˆ—è¡¨ï¼‰
                    let checkboxHtml = '';
                    result.documents.forEach(doc => {
                        const isChecked = selectedDocumentIds.includes(doc.document_id);
                        selectedDocuments[doc.document_id] = doc.filename; // ä¿å­˜æ˜ å°„
                        
                        checkboxHtml += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="doc_${doc.document_id}" 
                                       value="${doc.document_id}"
                                       ${isChecked ? 'checked' : ''}
                                       onchange="onDocumentSelectionChange()">
                                <label class="form-check-label" for="doc_${doc.document_id}">
                                    ğŸ“„ ${doc.filename}
                                </label>
                            </div>
                        `;
                    });
                    documentCheckboxList.innerHTML = checkboxHtml;
                    
                    // æ›´æ–°ä¾§è¾¹æ çš„æ–‡æ¡£åˆ—è¡¨
                    let documentsHtml = '';
                    result.documents.forEach(doc => {
                        const date = new Date(doc.created_at).toLocaleDateString();
                        const sizeKB = Math.round(doc.total_chars / 1024);
                        documentsHtml += `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-truncate" style="max-width: 150px;" title="${doc.filename}">
                                        ğŸ“„ ${doc.filename}
                                    </div>
                                    <small class="text-muted">
                                        ${doc.chunk_count} å— Â· ${sizeKB}KB Â· ${date}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument('${doc.document_id}')" title="åˆ é™¤æ–‡æ¡£">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;
                    });
                    documentsList.innerHTML = documentsHtml;
                } else {
                    // æ— æ–‡æ¡£çš„æƒ…å†µ
                    documentCheckboxList.innerHTML = `
                        <div class="text-muted text-center py-2">
                            <i class="bi bi-file-earmark"></i> æš‚æ— å¯é€‰æ–‡æ¡£
                        </div>
                    `;
                    documentsList.innerHTML = `
                        <div class="text-muted text-center">
                            <i class="bi bi-file-earmark"></i> æš‚æ— æ–‡æ¡£
                        </div>
                    `;
                }
                
                // æ›´æ–°é€‰æ‹©çŠ¶æ€æ˜¾ç¤º
                updateSelectedDocumentsDisplay();
                
            } catch (error) {
                console.error('åŠ è½½æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('documentCheckboxList').innerHTML = `
                    <div class="text-danger text-center py-2">
                        <i class="bi bi-exclamation-triangle"></i> åŠ è½½å¤±è´¥
                    </div>
                `;
                document.getElementById('documentsList').innerHTML = `
                    <div class="text-danger text-center">
                        <i class="bi bi-exclamation-triangle"></i> åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }

        // å¤šæ–‡æ¡£é€‰æ‹©ç›¸å…³å‡½æ•°
        function onDocumentSelectionChange() {
            // è·å–æ‰€æœ‰é€‰ä¸­çš„æ–‡æ¡£
            const checkboxes = document.querySelectorAll('#documentCheckboxList input[type="checkbox"]:checked');
            selectedDocumentIds = Array.from(checkboxes).map(cb => cb.value);
            
            updateSelectedDocumentsDisplay();
            
            // ç»™ç”¨æˆ·æç¤º
            if (selectedDocumentIds.length > 0) {
                const docNames = selectedDocumentIds.map(id => selectedDocuments[id]).join('ã€');
                addSystemMessage(`ğŸ“š å·²é€‰æ‹© ${selectedDocumentIds.length} ä¸ªæ–‡æ¡£ï¼š${docNames}ã€‚AIå°†åŸºäºè¿™äº›æ–‡æ¡£å›ç­”é—®é¢˜ã€‚`);
            } else {
                addSystemMessage('ğŸ§  å·²åˆ‡æ¢åˆ°çº¯å¤§æ¨¡å‹æ¨¡å¼ï¼ŒAIå°†åŸºäºè®­ç»ƒçŸ¥è¯†å›ç­”é—®é¢˜ã€‚');
            }
        }
        
        function selectAllDocuments() {
            const checkboxes = document.querySelectorAll('#documentCheckboxList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            onDocumentSelectionChange();
        }
        
        function clearDocumentSelection() {
            const checkboxes = document.querySelectorAll('#documentCheckboxList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            onDocumentSelectionChange();
        }
        
        function updateSelectedDocumentsDisplay() {
            const selectedInfo = document.getElementById('selectedDocumentsInfo');
            const countSpan = document.getElementById('selectedDocumentCount');
            const namesSpan = document.getElementById('selectedDocumentNames');
            
            if (selectedDocumentIds.length > 0) {
                const docNames = selectedDocumentIds.map(id => selectedDocuments[id]).join('ã€');
                countSpan.textContent = selectedDocumentIds.length;
                namesSpan.textContent = docNames;
                selectedInfo.style.display = 'block';
            } else {
                selectedInfo.style.display = 'none';
            }
        }

        // åˆ é™¤æ–‡æ¡£
        async function deleteDocument(documentId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadDocuments(); // åˆ·æ–°æ–‡æ¡£åˆ—è¡¨
                    checkServiceStatus(); // æ›´æ–°æœåŠ¡çŠ¶æ€
                    alert('æ–‡æ¡£åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.error);
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡æ¡£å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
            }
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServiceStatus() {
            try {
                const response = await fetch(`${API_BASE}/service-status`);
                const result = await response.json();
                
                if (result.success) {
                    const status = result.service_status;
                    const statusHtml = `
                        <div class="mb-2">
                            <small class="text-muted">AIæœåŠ¡:</small><br>
                            <span class="status-indicator ${status.ai_service.openai_available ? 'status-online' : 'status-offline'}"></span>
                            OpenAI: ${status.ai_service.openai_available ? 'åœ¨çº¿' : 'ç¦»çº¿'}<br>
                            <span class="status-indicator ${status.ai_service.deepseek_available ? 'status-online' : 'status-offline'}"></span>
                            DeepSeek: ${status.ai_service.deepseek_available ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">ä¼šè¯æœåŠ¡:</small><br>
                            <span class="status-indicator ${status.session_service.redis_connected ? 'status-online' : 'status-warning'}"></span>
                            ${status.session_service.storage_type === 'redis' ? 'Redis' : 'å†…å­˜'} å­˜å‚¨<br>
                            æ´»è·ƒä¼šè¯: ${status.session_service.active_sessions}
                        </div>
                        <div>
                            <small class="text-muted">æ–‡æ¡£æœåŠ¡:</small><br>
                            å·²ä¸Šä¼ æ–‡æ¡£: ${status.rag_service.document_count}
                        </div>
                    `;
                    document.getElementById('serviceStatus').innerHTML = statusHtml;
                }
            } catch (error) {
                document.getElementById('serviceStatus').innerHTML = 
                    '<div class="text-danger">æœåŠ¡çŠ¶æ€æ£€æŸ¥å¤±è´¥</div>';
            }
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        async function loadSessions() {
            try {
                const response = await fetch(`${API_BASE}/sessions`);
                const result = await response.json();
                
                if (result.success) {
                    const sessionList = document.getElementById('sessionList');
                    sessionList.innerHTML = '';
                    
                    if (result.sessions.length === 0) {
                        sessionList.innerHTML = '<div class="text-muted text-center">æš‚æ— ä¼šè¯</div>';
                        return;
                    }
                    
                    result.sessions.forEach(session => {
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = `session-item ${session.session_id === currentSessionId ? 'active' : ''}`;
                        const date = new Date(session.last_activity * 1000).toLocaleString();
                        sessionDiv.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <small>${session.session_id.substr(0, 12)}...</small>
                                <small>${session.conversation_count}è½®</small>
                            </div>
                            <small class="text-muted">${date}</small>
                        `;
                        sessionDiv.onclick = () => switchSession(session.session_id);
                        sessionList.appendChild(sessionDiv);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢ä¼šè¯
        async function switchSession(sessionId) {
            currentSessionId = sessionId;
            updateSessionStatus();
            clearChatContainer();
            
            // åŠ è½½ä¼šè¯å†å²
            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`);
                const result = await response.json();
                
                if (result.success && result.session_info.conversations) {
                    result.session_info.conversations.forEach(conv => {
                        addMessage(conv.question, true);
                        addMessage(conv.answer, false, {
                            model_used: conv.model_used,
                            context_used: true
                        });
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å†å²å¤±è´¥:', error);
            }
            
            loadSessions(); // æ›´æ–°ä¼šè¯åˆ—è¡¨çŠ¶æ€
        }

        // æ–‡æ¡£ä¸Šä¼ 
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> ä¸Šä¼ ä¸­...';
            
            let uploadResults = [];
            
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('file', files[i]);
                
                try {
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        uploadResults.push(`<div class="alert alert-success alert-sm">âœ… ${files[i].name} ä¸Šä¼ æˆåŠŸ</div>`);
                    } else {
                        uploadResults.push(`<div class="alert alert-danger alert-sm">âŒ ${files[i].name} ä¸Šä¼ å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>`);
                    }
                } catch (error) {
                    uploadResults.push(`<div class="alert alert-danger alert-sm">âŒ ${files[i].name} ç½‘ç»œé”™è¯¯</div>`);
                }
            }
            
            // æ¸…é™¤"ä¸Šä¼ ä¸­..."çŠ¶æ€ï¼Œæ˜¾ç¤ºæœ€ç»ˆç»“æœ
            statusDiv.innerHTML = uploadResults.join('');
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†
            fileInput.value = '';
            
            checkServiceStatus(); // æ›´æ–°æ–‡æ¡£æ•°é‡
            loadDocuments(); // åˆ·æ–°æ–‡æ¡£åˆ—è¡¨
        });

        // æ™ºèƒ½é—®ç­”
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) return;
            
            if (!currentSessionId) {
                newSession();
            }
            
            addMessage(question, true);
            questionInput.value = '';
            toggleLoading(true);
            
            try {
                const useDeepSeek = document.getElementById('useDeepSeek').checked;
                const response = await fetch(`${API_BASE}/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        use_deepseek: useDeepSeek,
                        session_id: currentSessionId,
                        document_ids: selectedDocumentIds // ä¼ é€’é€‰ä¸­çš„å¤šä¸ªæ–‡æ¡£ID
                    })
                });
                
                const result = await response.json();
                toggleLoading(false);
                
                if (result.success) {
                    addMessage(result.answer, false, {
                        model_used: result.model_used,
                        context_used: result.context_used
                    });
                    loadSessions(); // æ›´æ–°ä¼šè¯åˆ—è¡¨
                } else {
                    addMessage(`æŠ±æ­‰ï¼Œå›ç­”å¤±è´¥ï¼š${result.error}`, false);
                }
            } catch (error) {
                toggleLoading(false);
                addMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', false);
            }
        });

        // ç”Ÿæˆæ€»ç»“
        async function generateSummary() {
            const useDeepSeek = document.getElementById('summaryDeepSeek').checked;
            const responseDiv = document.getElementById('summaryResponse');
            
            responseDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">æ­£åœ¨ç”Ÿæˆæ€»ç»“...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/summary?use_deepseek=${useDeepSeek}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    responseDiv.innerHTML = `
                        <div class="response-box">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>ğŸ“‹ æ–‡æ¡£æ€»ç»“</h5>
                                <span class="model-badge model-${result.model_used.toLowerCase()}">${result.model_used}</span>
                            </div>
                            <div>${result.summary.replace(/\n/g, '<br>')}</div>
                            <hr>
                            <small class="text-muted">åŸºäº ${result.document_count} ä¸ªæ–‡æ¡£ç”Ÿæˆ</small>
                        </div>
                    `;
                } else {
                    responseDiv.innerHTML = `<div class="alert alert-warning">${result.error}</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = '<div class="alert alert-danger">ç½‘ç»œé”™è¯¯</div>';
            }
        }

        // ç”Ÿæˆç»ƒä¹ é¢˜
        async function generateQuiz() {
            const questionCount = document.getElementById('questionCount').value;
            const useDeepSeek = document.getElementById('quizDeepSeek').checked;
            const responseDiv = document.getElementById('quizResponse');
            
            responseDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">æ­£åœ¨ç”Ÿæˆç»ƒä¹ é¢˜...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/quiz`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_count: parseInt(questionCount),
                        use_deepseek: useDeepSeek
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.quiz.questions) {
                    let quizHtml = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>â“ ç»ƒä¹ é¢˜</h5>
                            <span class="model-badge model-${result.model_used.toLowerCase()}">${result.model_used}</span>
                        </div>
                    `;
                    
                    result.quiz.questions.forEach((q, index) => {
                        quizHtml += `<div class="quiz-container">
                            <h6>é¢˜ç›® ${index + 1}ï¼š${q.question}</h6>`;
                        
                        if (q.type === 'choice' && q.options) {
                            quizHtml += '<div class="mt-2">';
                            q.options.forEach((option, optIndex) => {
                                quizHtml += `<div class="quiz-option" onclick="selectOption(this, '${q.correct_answer}', '${option.charAt(0)}')">${option}</div>`;
                            });
                            quizHtml += '</div>';
                        } else if (q.type === 'judge') {
                            quizHtml += `
                                <div class="mt-2">
                                    <div class="quiz-option" onclick="selectOption(this, '${q.correct_answer}', 'true')">A. æ­£ç¡®</div>
                                    <div class="quiz-option" onclick="selectOption(this, '${q.correct_answer}', 'false')">B. é”™è¯¯</div>
                                </div>
                            `;
                        } else {
                            quizHtml += `<div class="mt-2"><strong>å‚è€ƒç­”æ¡ˆï¼š</strong>${q.correct_answer}</div>`;
                        }
                        
                        quizHtml += `<div class="mt-2"><small class="text-muted"><strong>è§£é‡Šï¼š</strong>${q.explanation}</small></div></div>`;
                    });
                    
                    responseDiv.innerHTML = quizHtml;
                } else {
                    responseDiv.innerHTML = `<div class="alert alert-warning">${result.error || 'ç»ƒä¹ é¢˜ç”Ÿæˆå¤±è´¥'}</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = '<div class="alert alert-danger">ç½‘ç»œé”™è¯¯</div>';
            }
        }

        // é€‰æ‹©é¢˜ç›®é€‰é¡¹
        function selectOption(element, correctAnswer, selectedAnswer) {
            // é‡ç½®åŒçº§é€‰é¡¹
            const siblings = element.parentNode.querySelectorAll('.quiz-option');
            siblings.forEach(sibling => {
                sibling.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // æ ‡è®°é€‰ä¸­
            element.classList.add('selected');
            
            // æ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                if (selectedAnswer === correctAnswer) {
                    element.classList.add('correct');
                } else {
                    element.classList.add('incorrect');
                    // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                    siblings.forEach(sibling => {
                        if (sibling.textContent.startsWith(correctAnswer)) {
                            sibling.classList.add('correct');
                        }
                    });
                }
            }, 100);
        }

        // ç”Ÿæˆå­¦ä¹ è®¡åˆ’
        async function generateStudyPlan() {
            const difficulty = document.getElementById('difficultyLevel').value;
            const useDeepSeek = document.getElementById('planDeepSeek').checked;
            const responseDiv = document.getElementById('planResponse');
            
            responseDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">æ­£åœ¨åˆ¶å®šå­¦ä¹ è®¡åˆ’...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/study-plan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        difficulty: difficulty,
                        use_deepseek: useDeepSeek
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    responseDiv.innerHTML = `
                        <div class="response-box">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>ğŸ“… å­¦ä¹ è®¡åˆ’</h5>
                                <span class="model-badge model-${result.model_used.toLowerCase()}">${result.model_used}</span>
                            </div>
                            <div>${result.study_plan.replace(/\n/g, '<br>')}</div>
                            <hr>
                            <small class="text-muted">éš¾åº¦çº§åˆ«ï¼š${result.difficulty} | åŸºäº ${result.document_count} ä¸ªæ–‡æ¡£</small>
                        </div>
                    `;
                } else {
                    responseDiv.innerHTML = `<div class="alert alert-warning">${result.error}</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = '<div class="alert alert-danger">ç½‘ç»œé”™è¯¯</div>';
            }
        }

        // å®šæœŸåˆ·æ–°ä¼šè¯çŠ¶æ€
        setInterval(() => {
            if (currentSessionId) {
                loadSessions();
            }
        }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html> 
</html> 